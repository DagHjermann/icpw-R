---
title: "120_Time_series_modelling"
author: "DHJ"
date: "8 5 2020"
output: html_document
---


## 1. Libraries  
```{r}

# All of tehse packages cn be loaded at once using library(tidyverse). (I just like to be specific.)
library(dplyr)
library(lubridate)
library(ggplot2)
library(forcats)
library(mgcv)
library(nlme)

```


## 2. Data  

### Read data
```{r}

dat_annual <- readRDS("Data/110_dat_annual_season_adjusted.rds") %>%
  mutate(station_id = levels(station_id)[as.numeric(station_id)])  # remove factor 

str(dat_annual)

```


## 3. Run time series analyses  
For each station separately

### Test with one time series
```{r}

df <- dat_annual %>%
  filter(!is.na(TOC)) %>%
  count(station_id) %>%
  arrange(n) %>% 
  filter(n >= 20)

dat_annual_test <- dat_annual %>%
  filter(station_id %in% df$station_id[1])

mod <- list(
  gamm(log_NO3_madj ~ s(year, k = 3), 
            correlation = corAR1(form =∼ year),
            data = dat_annual_test),
  gamm(log_NO3_madj ~ s(TOTN_dep, k = 3), 
            correlation = corAR1(form =∼ year),
            data = dat_annual_test),
  gamm(log_NO3_madj ~ s(TOTN_dep, k = 3) + s(year, k = 3), 
            correlation = corAR1(form =∼ year),
            data = dat_annual_test),
  gls(log_NO3_madj ~ TOC, 
            correlation = corAR1(form =∼ year),
            data = dat_annual_test %>% filter(!is.na(TOC))),
  gamm(log_NO3_madj ~ s(year, k = 3) + TOC, 
            correlation = corAR1(form =∼ year),
            data = dat_annual_test %>% filter(!is.na(TOC))),
  gamm(log_NO3_madj ~ s(TOTN_dep, k = 3) + TOC, 
            correlation = corAR1(form =∼ year),
            data = dat_annual_test %>% filter(!is.na(TOC))),
  gamm(log_NO3_madj ~ s(TOTN_dep, k = 3) + s(year, k = 3) + TOC, 
            correlation = corAR1(form =∼ year),
            data = dat_annual_test %>% filter(!is.na(TOC)))
)

anova <- anova(mod[[1]]$lme, mod[[2]]$lme, mod[[3]]$lme)
summary(mod[[which.min(anova$AIC)]]$gam) %>% str()

summary(mod[[which.min(anova$AIC)]]$gam)$s.table

par(mfrow = c(2,2), mar = c(4,5,2,1))
plot(mod[[1]]$gam)
plot(mod[[2]]$gam)
plot(mod[[3]]$gam)

par(mfrow = c(2,3), mar = c(4,5,2,1))
plot(mod[[5]]$gam)
plot(mod[[6]]$gam)
plot(mod[[7]]$gam)

# X <- plot(mod[[3]]$gam)
# str(X)

```

### All time series   
2-3 minutes  
```{r}

# Select data with >= 10 years
dat_annual_sel <- dat_annual %>%
  group_by(station_id) %>%
  mutate(n = n()) %>% 
  filter(n >= 10)

run_ts_analyses <- function(data){
  list <- list(
    gamm(log_NO3_madj ~ s(year, k = 3), 
         correlation = corAR1(form =∼ year),
         data = data),
    gamm(log_NO3_madj ~ s(TOTN_dep, k = 3), 
         correlation = corAR1(form =∼ year),
         data = data),
    gamm(log_NO3_madj ~ s(TOTN_dep, k = 3) + s(year, k = 3), 
         correlation = corAR1(form =∼ year),
         data = data),
    gamm(log_NO3_madj ~ s(TOC, k = 3) + s(year, k = 3), 
         correlation = corAR1(form =∼ year),
         data = data),
    years = data$year
  )
  data_TOC <- data %>% filter(!is.na(TOC))
  if (nrow(data_TOC) >= 12){
    list2 <- list(
      gls(log_NO3_madj ~ TOC, 
          correlation = corAR1(form =∼ year),
          data = data_TOC),
      gamm(log_NO3_madj ~ s(year, k = 3) + TOC, 
           correlation = corAR1(form =∼ year),
           data = data_TOC),
      gamm(log_NO3_madj ~ s(TOTN_dep, k = 3) + TOC, 
           correlation = corAR1(form =∼ year),
           data = data_TOC),
      gamm(log_NO3_madj ~ s(TOTN_dep, k = 3) + s(year, k = 3) + TOC, 
           correlation = corAR1(form =∼ year),
           data = data_TOC)
    )
    list <- c(list, list2)
  }
  list
}
# Test
# mod <- run_ts_analyses(dat_annual_test)

# Safe version
run_ts_analyses_safe <- safely(run_ts_analyses)

# Split data
dat_annual_split <- dat_annual_sel %>%
  group_by(station_id) %>%
  group_split()

# Name the split data
names(dat_annual_split) <- dat_annual_split %>% map_chr(~.$station_id[1])

# Run all models  
t0 <- Sys.time()
ts_model_list <- dat_annual_split %>% 
  map(run_ts_analyses_safe) %>%
  transpose()
Sys.time() - t0  


```

## 4. Save
```{r}

saveRDS(dat_annual_sel, "Data/120_dat_annual_sel.rds")
saveRDS(ts_model_list, "Data/120_ts_model_list.rds")

```



### Put results together 

adjustment_ok
```{r}

# Which adjustments did not retun an error?
adjustment_ok <- ts_model_list$error %>% map_lgl(is.null)
table(adjustment_ok)

# Set names for result
names(ts_model_list$result) <- names(dat_annual_split)

# Check contents of $result
ts_model_list$result[[1]] %>% str(2)

```

AIC
```{r}
get_anova <- function(model_list){
  anova(model_list[[1]]$lme, model_list[[2]]$lme, model_list[[3]]$lme)
}
# get_anova(ts_model_list$result[[1]])
# get_anova(ts_model_list$result[[1]])$AIC %>% matrix(nrow = 1) %>% data.frame()

get_aic <- function(model_list){
  get_anova(model_list)$AIC %>% matrix(nrow = 1) %>% data.frame() 
}
# get_aic(ts_model_list$result[[1]])

aic <- ts_model_list$result[adjustment_ok] %>% map_df(get_aic, .id = "station_id")
names(aic)[2:4] <- paste0("AIC_", 1:3)

aic <- aic %>%
  mutate(AIC_min = min(AIC_1, AIC_2, AIC_3),
         dAIC_1 = AIC_1 - AIC_min,
         dAIC_2 = AIC_2 - AIC_min,
         dAIC_3 = AIC_3 - AIC_min)

```

p-values  
```{r}

# ts_model_list$result[[1]] %>% str(2)
# ts_model_list$result[[1]][[1]] %>% str(1)
# summary(ts_model_list$result[[1]][[3]]$gam)$s.table
# x <- summary(ts_model_list$result[[1]][[3]]$gam)$s.table
# str(x)
# x[,4]

get_p <- function(model_list){
  tab1 <- summary(model_list[[1]]$gam)$s.table
  tab2 <- summary(model_list[[2]]$gam)$s.table
  tab3 <- summary(model_list[[3]]$gam)$s.table
  data.frame(year_m1 = tab1[1,4],
             totn_m2 = tab2[1,4],
             year_m3 = tab3[2,4],
             totn_m3 = tab3[1,4])
}
# get_p(ts_model_list$result[[1]])

p_values <- ts_model_list$result[adjustment_ok] %>% map_df(get_p, .id = "station_id")

```


Predict
```{r}

predict(ts_model_list$result[[1]][[1]]$gam, data.frame(year = 1992:2020))
ts_model_list$result[[1]]$years

get_predictions_time <- function(model_list){
  years <- seq(
    min(model_list$years),
    max(model_list$years)
  )
  pred <- predict(model_list[[1]]$gam, data.frame(year = years))
  data.frame(year = years, log_NO3_pred = pred)
}

# Test
# get_predictions_time(ts_model_list$result[[1]])

get_increase <- function(model_list){
  df_pred <- get_predictions_time(model_list)
  value1 <- df_pred %>%
    filter(year %in% 1992:1994) %>%
    pull(log_NO3_pred) %>%
    mean()
  value2 <- df_pred %>%
    filter(year %in% 2014:2016) %>%
    pull(log_NO3_pred) %>%
    mean()
  data.frame(increase = value2 - value1)
  }
# test
# get_increase(ts_model_list$result[[1]])

increase <- ts_model_list$result[adjustment_ok] %>% map_df(get_increase, .id = "station_id")

hist(increase$increase, na.rm = TRUE)

```




### Add AIC and p_values to dat_annual

```{r}

dat_annual2 <- dat_annual %>%
  left_join(aic, by = "station_id") %>%
  left_join(p_values, by = "station_id") %>%
  left_join(increase, by = "station_id")
  

```

### Plots
```{r}

ggplot(dat_annual2, aes(latitude, dAIC_1)) +
  geom_point()

ggplot(dat_annual2, aes(latitude, altitude, color = year_m1)) +
  geom_point() +
  viridis::scale_color_viridis(option = "inferno") 

ggplot(dat_annual2, aes(longitude, latitude, color = year_m1)) +
  geom_point() +
  viridis::scale_color_viridis(option = "inferno") 

dat_annual2 %>%
  mutate(increase2 = case_when(
    increase > 1 ~ 1,
    increase < -1 ~ -1,
    TRUE ~ increase
  )) %>%
ggplot(aes(longitude, latitude, color = increase2)) +
  geom_point() +
  scale_color_gradient2(midpoint = 0)

```


```{r}

```

